import{e as x}from"./index-86dek2aJ.js";import{aB as A,r as m}from"./vue-BoURs06I.js";import{E as I}from"./element-BmFU88f4.js";async function L(r,e){const t=r.getReader();let n;for(;!(n=await t.read()).done;)e(n.value)}function P(r){let e,t,n,a=!1;return function(i){e===void 0?(e=i,t=0,n=-1):e=H(e,i);const o=e.length;let s=0;for(;t<o;){a&&(e[t]===10&&(s=++t),a=!1);let c=-1;for(;t<o&&c===-1;++t)switch(e[t]){case 58:n===-1&&(n=t-s);break;case 13:a=!0;case 10:c=t;break}if(c===-1)break;r(e.subarray(s,c),n),s=t,n=-1}s===o?e=void 0:s!==0&&(e=e.subarray(s),t-=s)}}function N(r,e,t){let n=_();const a=new TextDecoder;return function(i,o){if(i.length===0)t==null||t(n),n=_();else if(o>0){const s=a.decode(i.subarray(0,o)),c=o+(i[o+1]===32?2:1),u=a.decode(i.subarray(c));switch(s){case"data":n.data=n.data?n.data+`
`+u:u;break;case"event":n.event=u;break;case"id":r(n.id=u);break;case"retry":const f=parseInt(u,10);isNaN(f)||e(n.retry=f);break}}}}function H(r,e){const t=new Uint8Array(r.length+e.length);return t.set(r),t.set(e,r.length),t}function _(){return{data:"",event:"",id:"",retry:void 0}}var R=function(r,e){var t={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,n=Object.getOwnPropertySymbols(r);a<n.length;a++)e.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(r,n[a])&&(t[n[a]]=r[n[a]]);return t};const O="text/event-stream",W=1e3,T="last-event-id";function B(r,e){var{signal:t,headers:n,onopen:a,onmessage:d,onclose:i,onerror:o,openWhenHidden:s,fetch:c}=e,u=R(e,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((f,k)=>{const h=Object.assign({},n);h.accept||(h.accept=O);let v;function E(){v.abort(),document.hidden||g()}s||document.addEventListener("visibilitychange",E);let S=W,b=0;function p(){document.removeEventListener("visibilitychange",E),window.clearTimeout(b),v.abort()}t==null||t.addEventListener("abort",()=>{p(),f()});const j=c??window.fetch,C=a??D;async function g(){var w;v=new AbortController;try{const y=await j(r,Object.assign(Object.assign({},u),{headers:h,signal:v.signal}));await C(y),await L(y.body,P(N(l=>{l?h[T]=l:delete h[T]},l=>{S=l},d))),i==null||i(),p(),f()}catch(y){if(!v.signal.aborted)try{const l=(w=o==null?void 0:o(y))!==null&&w!==void 0?w:S;window.clearTimeout(b),b=window.setTimeout(g,l)}catch(l){p(),k(l)}}}g()})}function D(r){const e=r.headers.get("content-type");if(!(e!=null&&e.startsWith(O)))throw new Error(`Expected content-type to be ${O}, Actual: ${e}`)}function U(r,e){const t=new AbortController,n=JSON.stringify(r);B("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:n,...e,signal:t.signal,onerror(a){var d;throw(d=e==null?void 0:e.onerror)==null||d.call(e,a),I.error("对话请求发生网络错误或涉及违规话题"),t.abort(),a}})}const J=A("chat",()=>{const r=m(3),e=m("chatglm3-6b"),t=m(.8),n=m("llm_chat"),a=x();return{chat:async(i,o)=>{U({...i,user_id:a.username,history_len:r.value,stream:!0,model_name:e.value,temperature:t.value,max_tokens:1024,prompt_name:n.value},o)},history_len:r,model_name:e,temperature:t,prompt_name:n}});export{J as u};
