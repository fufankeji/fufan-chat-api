import{i as b,e as j,j as k}from"./index-BmLxQ8AD.js";import{aB as T,r as g}from"./vue-39WfQX0x.js";import{E as M}from"./element-DGJpsW9c.js";function ee(t){return b({url:"/api/conversations",method:"post",data:t})}function te(t){return b({url:`/api/conversations/${t}`,method:"delete"})}function ne(t){return b({url:`/api/conversations/${t.conversationId}/update_name`,method:"put",data:{name:t.name}})}function W(t){return b({url:`/api/conversations/${t}/messages`,method:"get"})}async function x(t,e){const n=t.getReader();let a;for(;!(a=await n.read()).done;)e(a.value)}function P(t){let e,n,a,r=!1;return function(s){e===void 0?(e=s,n=0,a=-1):e=q(e,s);const i=e.length;let l=0;for(;n<i;){r&&(e[n]===10&&(l=++n),r=!1);let h=-1;for(;n<i&&h===-1;++n)switch(e[n]){case 58:a===-1&&(a=n-l);break;case 13:r=!0;case 10:h=n;break}if(h===-1)break;t(e.subarray(l,h),a),l=n,a=-1}l===i?e=void 0:l!==0&&(e=e.subarray(l),n-=l)}}function $(t,e,n){let a=O();const r=new TextDecoder;return function(s,i){if(s.length===0)n==null||n(a),a=O();else if(i>0){const l=r.decode(s.subarray(0,i)),h=i+(s[i+1]===32?2:1),v=r.decode(s.subarray(h));switch(l){case"data":a.data=a.data?a.data+`
`+v:v;break;case"event":a.event=v;break;case"id":t(a.id=v);break;case"retry":const f=parseInt(v,10);isNaN(f)||e(a.retry=f);break}}}}function q(t,e){const n=new Uint8Array(t.length+e.length);return n.set(t),n.set(e,t.length),n}function O(){return{data:"",event:"",id:"",retry:void 0}}var D=function(t,e){var n={};for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&e.indexOf(a)<0&&(n[a]=t[a]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,a=Object.getOwnPropertySymbols(t);r<a.length;r++)e.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(t,a[r])&&(n[a[r]]=t[a[r]]);return n};const S="text/event-stream",G=1e3,I="last-event-id";function L(t,e){var{signal:n,headers:a,onopen:r,onmessage:d,onclose:s,onerror:i,openWhenHidden:l,fetch:h}=e,v=D(e,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((f,H)=>{const p=Object.assign({},a);p.accept||(p.accept=S);let o;function c(){o.abort(),document.hidden||C()}l||document.addEventListener("visibilitychange",c);let y=G,u=0;function A(){document.removeEventListener("visibilitychange",c),window.clearTimeout(u),o.abort()}n==null||n.addEventListener("abort",()=>{A(),f()});const N=h??window.fetch,R=r??J;async function C(){var E;o=new AbortController;try{const w=await N(t,Object.assign(Object.assign({},v),{headers:p,signal:o.signal}));await R(w),await x(w.body,P($(m=>{m?p[I]=m:delete p[I]},m=>{y=m},d))),s==null||s(),A(),f()}catch(w){if(!o.signal.aborted)try{const m=(E=i==null?void 0:i(w))!==null&&E!==void 0?E:y;window.clearTimeout(u),u=window.setTimeout(C,m)}catch(m){A(),H(m)}}}C()})}function J(t){const e=t.headers.get("content-type");if(!(e!=null&&e.startsWith(S)))throw new Error(`Expected content-type to be ${S}, Actual: ${e}`)}function U(t,e){const n=new AbortController,a=JSON.stringify(t);L("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:a,...e,signal:n.signal,onerror(r){var d;throw(d=e==null?void 0:e.onerror)==null||d.call(e,r),M.error("对话请求发生网络错误或涉及违规话题"),n.abort(),r}})}function V(t,e){const n=new AbortController,a=JSON.stringify(t);L("/api/chat/search_engine_chat",{method:"POST",headers:{"Content-Type":"application/json"},body:a,...e,signal:n.signal,onerror(r){var d;throw(d=e==null?void 0:e.onerror)==null||d.call(e,r),M.error("对话请求发生网络错误或涉及违规话题"),n.abort(),r}})}var _=(t=>(t.GENERAL_CHAT="general_chat",t.CHAT_WITH_RETRIEVAL="chat_with_retrieval",t.CHAT_WITH_SEARCH="chat_with_search",t.CHAT_WITH_RECOMMEND="chat_with_recommend",t))(_||{});function B(){return b({url:"/api/llm_model/list_running_models",method:"get"})}const F=T("llmModel",()=>{const t=g([]),e=g("chatglm3-6b");return{getLlmModels:async()=>{const{data:r}=await B();t.value=r.models},setModuleName:r=>{e.value=r},llm_models:t,model_name:e}}),z={"/chat":_.GENERAL_CHAT,"/AISearch":_.CHAT_WITH_SEARCH,"/knowledge":_.CHAT_WITH_RETRIEVAL,"/recommend":_.CHAT_WITH_RECOMMEND},K=T("chat",()=>{const t=g(_.GENERAL_CHAT),e=g(""),n=g([]),a=g(),r=Q(),d=F(),s=o=>{t.value=z[o]||_.GENERAL_CHAT,r.getConversations(),i()},i=(o="")=>{if(e.value=o,!o){n.value=[];return}},l=o=>{a.value=o},h=async()=>{const o=await W(e.value);n.value=o.data},v=o=>{var y,u;const c={id:"",conversation_id:e.value,chat_type:t.value,query:o,response:"",create_time:""};(y=n.value)==null||y.push(c),(u=a.value)==null||u.call(a)},f=async o=>{var y;const c=JSON.parse(o.data);n.value&&(n.value.map(async u=>{c&&(u.id===(c==null?void 0:c.message_id)||u.id==="")&&(u.id=c.message_id,c.text&&(u.response+=c.text),c.docs&&(u.docs=c.docs),c.search&&(u.search=c.search))}),(y=a.value)==null||y.call(a))};return{chat:async o=>{v(o.query),U({...o,conversation_id:e.value,model_name:d.model_name},{onmessage:f})},chatAISearch:async o=>{v(o.query),V({...o,conversation_id:e.value,model_name:d.model_name},{onmessage:f})},setChatType:s,onSelectConversation:i,setOnScrollBottom:l,getChatHistory:h,chat_type:t,conversation_id:e,chat_history:n}}),Q=T("chatHistory",()=>{const t=g(!1),e=g([]),n=j(),a=K(),r=async()=>{const s=await k({user_id:n.token,chat_type:a.chat_type});e.value=s.data};return{setShowHistory:async s=>{t.value=s,s&&r()},getConversations:r,show_history:t,conversations:e}});export{K as a,ne as b,ee as c,te as d,F as e,Q as u};
